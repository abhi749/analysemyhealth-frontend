<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthAI Platform - Debug Version</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .app-container {
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            max-width: 520px;
            width: 100%;
            text-align: center;
        }

        .brand {
            font-size: 2.8rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .version-tag {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-block;
            margin-left: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .description {
            color: #666;
            margin-bottom: 35px;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .benefit-card {
            display: flex;
            align-items: flex-start;
            margin: 25px 0;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 16px;
            text-align: left;
            border: 1px solid #e8ecff;
        }

        .benefit-icon {
            font-size: 1.8rem;
            margin-right: 18px;
            width: 36px;
            flex-shrink: 0;
        }

        .benefit-content h3 {
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .benefit-content p {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .debug-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .debug-title {
            color: #856404;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .debug-info {
            font-family: monospace;
            font-size: 0.9rem;
            color: #666;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .auth-section {
            margin-top: 40px;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f4f8 100%);
            border-radius: 20px;
            border: 2px solid #e0e8ff;
        }

        .auth-title {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .signin-button {
            display: block;
            width: 100%;
            padding: 18px 24px;
            background: #4285f4;
            color: white;
            text-decoration: none;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.3);
        }

        .signin-button:hover {
            background: #3367d6;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(66, 133, 244, 0.4);
        }

        .test-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: 500;
        }

        .clear-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .dashboard-view {
            display: none;
            text-align: left;
        }

        .status-loading {
            display: none;
            background: #fff8e1;
            color: #f57c00;
            padding: 25px;
            border-radius: 16px;
            margin-top: 25px;
            text-align: center;
            border: 2px solid #ffb74d;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Debug Section -->
        <div class="debug-section">
            <div class="debug-title">üîç Debug Information</div>
            <div>
                <strong>Browser:</strong> <span id="browserInfo">Loading...</span><br>
                <strong>URL:</strong> <span id="urlInfo">Loading...</span><br>
                <strong>Errors Found:</strong> <span id="errorCount">0</span>
                <button class="clear-button" onclick="clearDebugLog()">Clear Log</button>
            </div>
            <div class="debug-info" id="debugLog">Starting debug session...</div>
        </div>

        <!-- Authentication Screen -->
        <div id="authScreen">
            <div class="brand">
                HealthAI
                <span class="version-tag">DEBUG</span>
            </div>
            <p class="description">
                Debug version with comprehensive error tracking and logging.
            </p>

            <div class="benefit-card">
                <div class="benefit-icon">üîí</div>
                <div class="benefit-content">
                    <h3>Zero-Knowledge Privacy</h3>
                    <p>Your health data is encrypted on your device before uploading. We cannot see or access your personal health information - only you can decrypt it.</p>
                </div>
            </div>

            <div class="auth-section">
                <h3 class="auth-title">üöÄ Authentication Testing</h3>
                
                <div style="margin-bottom: 20px;">
                    <button class="test-button" onclick="testJavaScriptBasics()">Test JavaScript Basics</button>
                    <button class="test-button" onclick="testDOMAccess()">Test DOM Access</button>
                    <button class="test-button" onclick="testFetchAPI()">Test Fetch API</button>
                </div>

                <a href="https://accounts.google.com/oauth/authorize?client_id=674371229764-dbvid7j0lk44267igqkk87tg1onf4m2r.apps.googleusercontent.com&redirect_uri=https://analysemyhealth.com/new-index.html&response_type=code&scope=openid%20email%20profile&access_type=offline&prompt=select_account" 
                   class="signin-button" onclick="logDebug('OAuth redirect initiated')">
                    üîê Start OAuth Flow (Debug)
                </a>

                <button class="test-button" onclick="simulateOAuthReturn()">Simulate OAuth Return</button>
            </div>

            <div id="authProcessing" class="status-loading">
                <strong>Processing OAuth return...</strong><br>
                Check debug log for details.
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboardScreen" class="dashboard-view">
            <h2>Dashboard Reached Successfully!</h2>
            <p>If you see this, the authentication flow worked.</p>
            <button class="test-button" onclick="returnToAuth()">Return to Auth Screen</button>
        </div>
    </div>

    <script>
        // Global error tracking
        let debugErrors = [];
        let debugLogs = [];

        // Capture all JavaScript errors
        window.addEventListener('error', function(event) {
            const errorInfo = {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error ? event.error.stack : 'No stack trace',
                timestamp: new Date().toISOString()
            };
            
            debugErrors.push(errorInfo);
            logDebug(`ERROR: ${event.message} at ${event.filename}:${event.lineno}`, 'error');
            updateErrorCount();
        });

        // Capture unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            const errorInfo = {
                reason: event.reason,
                timestamp: new Date().toISOString()
            };
            
            debugErrors.push(errorInfo);
            logDebug(`PROMISE REJECTION: ${event.reason}`, 'error');
            updateErrorCount();
        });

        // Debug logging function
        function logDebug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            
            debugLogs.push(logEntry);
            
            const debugLog = document.getElementById('debugLog');
            if (debugLog) {
                debugLog.innerHTML = debugLogs.join('<br>') + '<br>';
                debugLog.scrollTop = debugLog.scrollHeight;
            }
            
            // Also log to browser console
            console.log(logEntry);
        }

        function updateErrorCount() {
            const errorCountElement = document.getElementById('errorCount');
            if (errorCountElement) {
                errorCountElement.textContent = debugErrors.length;
                errorCountElement.style.color = debugErrors.length > 0 ? 'red' : 'green';
            }
        }

        function clearDebugLog() {
            debugLogs = [];
            debugErrors = [];
            document.getElementById('debugLog').innerHTML = 'Debug log cleared...';
            updateErrorCount();
        }

        // Initialize debug info
        function initializeDebug() {
            try {
                logDebug('Initializing HealthAI Debug Version');
                
                // Browser info
                const browserInfo = navigator.userAgent;
                document.getElementById('browserInfo').textContent = browserInfo.substring(0, 50) + '...';
                
                // URL info
                document.getElementById('urlInfo').textContent = window.location.href;
                
                logDebug(`Browser: ${browserInfo}`);
                logDebug(`URL: ${window.location.href}`);
                logDebug(`User Agent: ${navigator.userAgent}`);
                
                // Check for URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const oauthCode = urlParams.get('code');
                const oauthError = urlParams.get('error');
                
                if (oauthCode) {
                    logDebug(`OAuth code detected: ${oauthCode.substring(0, 20)}...`);
                    handleOAuthReturn(oauthCode);
                } else if (oauthError) {
                    logDebug(`OAuth error detected: ${oauthError}`, 'error');
                } else {
                    logDebug('No OAuth parameters in URL');
                }
                
                // Check existing session
                const existingUser = localStorage.getItem('healthai_debug_user');
                if (existingUser) {
                    logDebug('Found existing user session');
                    try {
                        const userData = JSON.parse(existingUser);
                        logDebug(`User: ${userData.name} (${userData.email})`);
                        displayDashboard(userData);
                    } catch (error) {
                        logDebug(`Error parsing user data: ${error.message}`, 'error');
                        localStorage.removeItem('healthai_debug_user');
                    }
                } else {
                    logDebug('No existing user session found');
                }
                
            } catch (error) {
                logDebug(`Initialization error: ${error.message}`, 'error');
            }
        }

        // Test functions
        function testJavaScriptBasics() {
            try {
                logDebug('Testing JavaScript basics...');
                
                // Test basic operations
                const testVar = 'Hello World';
                logDebug(`Variable assignment: ${testVar}`);
                
                // Test array operations
                const testArray = [1, 2, 3];
                logDebug(`Array operations: ${testArray.length} items`);
                
                // Test object operations
                const testObj = { name: 'test', value: 123 };
                logDebug(`Object operations: ${JSON.stringify(testObj)}`);
                
                logDebug('JavaScript basics test: PASSED', 'success');
                
            } catch (error) {
                logDebug(`JavaScript basics test FAILED: ${error.message}`, 'error');
            }
        }

        function testDOMAccess() {
            try {
                logDebug('Testing DOM access...');
                
                // Test element access
                const brandElement = document.querySelector('.brand');
                logDebug(`Brand element found: ${brandElement ? 'YES' : 'NO'}`);
                
                // Test element creation
                const testDiv = document.createElement('div');
                testDiv.textContent = 'Test element';
                logDebug(`Element creation: ${testDiv.tagName}`);
                
                // Test event handling
                const testButton = document.createElement('button');
                testButton.onclick = () => logDebug('Test button clicked');
                logDebug(`Event handling setup: OK`);
                
                logDebug('DOM access test: PASSED', 'success');
                
            } catch (error) {
                logDebug(`DOM access test FAILED: ${error.message}`, 'error');
            }
        }

        function testFetchAPI() {
            try {
                logDebug('Testing Fetch API...');
                
                // Test if fetch is available
                if (typeof fetch === 'undefined') {
                    throw new Error('Fetch API not available');
                }
                
                logDebug('Fetch API available: YES');
                
                // Test simple fetch (to same domain to avoid CORS)
                fetch('/new-index.html', { method: 'HEAD' })
                    .then(response => {
                        logDebug(`Fetch test response: ${response.status} ${response.statusText}`, 'success');
                    })
                    .catch(error => {
                        logDebug(`Fetch test error: ${error.message}`, 'error');
                    });
                
            } catch (error) {
                logDebug(`Fetch API test FAILED: ${error.message}`, 'error');
            }
        }

        function simulateOAuthReturn() {
            logDebug('Simulating OAuth return...');
            
            const fakeCode = 'test_code_123456789';
            logDebug(`Using fake OAuth code: ${fakeCode}`);
            
            handleOAuthReturn(fakeCode);
        }

        async function handleOAuthReturn(authCode) {
            try {
                logDebug(`Processing OAuth code: ${authCode.substring(0, 20)}...`);
                
                document.getElementById('authProcessing').style.display = 'block';
                
                const requestBody = {
                    code: authCode,
                    redirect_uri: window.location.origin + '/new-index.html'
                };
                
                logDebug(`Request body: ${JSON.stringify(requestBody)}`);
                
                const authResponse = await fetch('https://analysemyhealth-backend.abhishekgaur749.workers.dev/auth/google/callback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                logDebug(`Auth response status: ${authResponse.status} ${authResponse.statusText}`);

                if (!authResponse.ok) {
                    const errorText = await authResponse.text();
                    throw new Error(`Authentication failed: ${authResponse.status} - ${errorText}`);
                }

                const authData = await authResponse.json();
                logDebug(`Auth response data: ${JSON.stringify(authData)}`);
                
                // Store authenticated user data
                localStorage.setItem('healthai_debug_user', JSON.stringify(authData.user));
                localStorage.setItem('healthai_debug_token', authData.token);
                
                logDebug('User data stored successfully');
                
                // Clean URL and show dashboard
                window.history.replaceState({}, document.title, '/new-index.html');
                displayDashboard(authData.user);

            } catch (error) {
                logDebug(`OAuth processing error: ${error.message}`, 'error');
                logDebug(`Error stack: ${error.stack}`, 'error');
            } finally {
                document.getElementById('authProcessing').style.display = 'none';
            }
        }

        function displayDashboard(userData) {
            try {
                logDebug(`Displaying dashboard for user: ${userData.name}`);
                
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('dashboardScreen').style.display = 'block';
                
                logDebug('Dashboard displayed successfully', 'success');
                
            } catch (error) {
                logDebug(`Dashboard display error: ${error.message}`, 'error');
            }
        }

        function returnToAuth() {
            logDebug('Returning to auth screen');
            document.getElementById('dashboardScreen').style.display = 'none';
            document.getElementById('authScreen').style.display = 'block';
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDebug);
        } else {
            initializeDebug();
        }

        // Log when page is fully loaded
        window.addEventListener('load', function() {
            logDebug('Page fully loaded', 'success');
        });
    </script>
</body>
</html>
